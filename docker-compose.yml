# Orchard Docker Compose Configuration
# Run: docker compose up --build

services:
  # ==========================================================================
  # Terminal Daemon - PTY session manager (must start first)
  # ==========================================================================
  terminal-daemon:
    build:
      context: .
      target: terminal-daemon
    container_name: orchard-terminal-daemon
    ports:
      - "3002:3002"
    volumes:
      # Mount workspace for project access
      - ${WORKSPACE_PATH:-./workspace}:/workspace
      # Persist terminal session data
      - orchard-data:/app/.orchard
    environment:
      - NODE_ENV=production
      - PORT=3002
    healthcheck:
      test: ["CMD", "node", "-e", "require('net').createConnection(3002, 'localhost').on('connect', () => process.exit(0)).on('error', () => process.exit(1))"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - orchard-network

  # ==========================================================================
  # Server - Fastify REST API & WebSocket
  # ==========================================================================
  server:
    build:
      context: .
      target: server
    container_name: orchard-server
    ports:
      - "3001:3001"
    volumes:
      # Mount workspace for project access
      - ${WORKSPACE_PATH:-./workspace}:/workspace
      # Persist database and configuration
      - orchard-data:/app/.orchard
    environment:
      - NODE_ENV=production
      - PORT=3001
      - TERMINAL_DAEMON_URL=ws://terminal-daemon:3002
    depends_on:
      terminal-daemon:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:3001/health').then(r => process.exit(r.ok ? 0 : 1)).catch(() => process.exit(1))"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - orchard-network

  # ==========================================================================
  # Web Frontend - React with nginx (serves static files + proxies API)
  # ==========================================================================
  web:
    build:
      context: .
      target: web
    container_name: orchard-web
    ports:
      - "5173:5173"
    depends_on:
      server:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - orchard-network

# ==========================================================================
# Networks
# ==========================================================================
networks:
  orchard-network:
    driver: bridge

# ==========================================================================
# Volumes
# ==========================================================================
volumes:
  orchard-data:
    driver: local
